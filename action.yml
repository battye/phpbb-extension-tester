# Clone, create branch, move folders, commit changes
# See see https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
# TODO: Specify phpbb branch?
name: Test phpBB Extension in Codespaces

# TODO: refine this to certain actions
#on:
#  workflow_dispatch:
#    inputs:
#      branch_name:
#        description: 'Name of the new branch'
#        required: true
#        default: 'codespaces/2024-10-06-test'

runs:
  using: "composite"
  steps:
  - name: Checkout current repository
    uses: actions/checkout@v4
  - name: Clone external phpBB repository
    shell: bash
    run: |
      sudo mkdir -p /workspace/phpbb
      sudo git clone -b 3.3.x --single-branch https://github.com/phpbb/phpbb.git /workspace/phpbb
  - name: Move Codespaces files back to the current repository
    shell: bash
    run: |
      sudo mv /workspace/phpbb/.devcontainer .devcontainer
      sudo mv /workspace/phpbb/.vscode .vscode
  # Open composer.json from the user package, extract the name from the 'name' attribute
  - name: Adjust extension name in setup, launcher and installer
    shell: bash
    run: |
      EXT_NAME=$(jq .name composer.json)
      EXT_NAME_STRIPPED=$(echo $EXT_NAME | awk -F '/' '{print $NF}' | tr -d '"')
      echo "EXTENSION_NAME=$(echo $EXT_NAME_STRIPPED)" >> $GITHUB_ENV

      sed -i "s/PHPBB_EXTENSION_NAME/$EXT_NAME_STRIPPED/g" "${{ github.action_path }}/setup.sh"

      sudo sed -i "s/\/var\/www\/html/\/var\/www\/html\/ext\/phpbb\/$EXT_NAME_STRIPPED/g" .vscode/launch.json
      sudo sed -i "s/\/phpBB\//\//g" .vscode/launch.json

      sudo sed -i "s/\[\]/\[${EXT_NAME//\//\\/}\]/g" .devcontainer/resources/phpbb-config.yml
  # Don't use ${{ github.event.inputs.branch_name }} codespaces/test-${{ env.NOW_DATE }} yet "/var/www/html/ext/phpbb/titania":
  - name: Copy a custom setup.sh file
    shell: bash
    run: |
      sudo rm -rf .devcontainer/resources/setup.sh
      cat "${{ github.action_path }}/setup.sh" | sudo tee '.devcontainer/resources/setup.sh' > '/dev/null'
  - name: Save to a new branch
    shell: bash
    run: |
      echo "NOW_DATE=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
      git config user.email "github-actions[bot]@users.noreply.github.com"
      git config user.name "github-actions[bot]"
      git checkout -b test-$(date +%Y%m%d%H%M)/codespace
      git add .
      git commit -m "Codespaces setup"
      git push -u origin test-$(date +%Y%m%d%H%M)/codespace
